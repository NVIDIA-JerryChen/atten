PYTHON ?= python

# 1 enbale, 0 disable
BACKWARD ?= 0
SPLIT ?= 0
PAGEDKV ?= 0
APPENDKV ?= 0
LOCAL ?= 0
SOFTCAP ?= 0
PACKGQA ?= 0
FP16 ?= 0
FP8 ?= 0
VARLEN ?= 0
CLUSTER ?= 0
HDIM64 ?= 0
HDIM96 ?= 0
HDIM128 ?= 1
HDIM192 ?= 0
HDIM256 ?= 0
SM8X ?= 1
VCOLMAJOR ?= 0
HDIMDIFF64 ?= 0
HDIMDIFF192 ?= 0

ON_VALUES := 1 true TRUE yes YES on ON
bool_false_if_on = $(if $(filter $(ON_VALUES),$($(1))),FALSE,TRUE)
bool_true_if_on  = $(if $(filter $(ON_VALUES),$($(1))),TRUE,FALSE)

export FLASH_ATTENTION_DISABLE_BACKWARD := $(call bool_false_if_on,BACKWARD)
export FLASH_ATTENTION_DISABLE_SPLIT := $(call bool_false_if_on,SPLIT)
export FLASH_ATTENTION_DISABLE_PAGEDKV := $(call bool_false_if_on,PAGEDKV)
export FLASH_ATTENTION_DISABLE_APPENDKV := $(call bool_false_if_on,APPENDKV)
export FLASH_ATTENTION_DISABLE_LOCAL := $(call bool_false_if_on,LOCAL)
export FLASH_ATTENTION_DISABLE_SOFTCAP := $(call bool_false_if_on,SOFTCAP)
export FLASH_ATTENTION_DISABLE_PACKGQA := $(call bool_false_if_on,PACKGQA)
export FLASH_ATTENTION_DISABLE_FP16 := $(call bool_false_if_on,FP16)
export FLASH_ATTENTION_DISABLE_FP8 := $(call bool_false_if_on,FP8)
export FLASH_ATTENTION_DISABLE_VARLEN := $(call bool_false_if_on,VARLEN)
export FLASH_ATTENTION_DISABLE_CLUSTER := $(call bool_false_if_on,CLUSTER)
export FLASH_ATTENTION_DISABLE_HDIM64 := $(call bool_false_if_on,HDIM64)
export FLASH_ATTENTION_DISABLE_HDIM96 := $(call bool_false_if_on,HDIM96)
export FLASH_ATTENTION_DISABLE_HDIM128 := $(call bool_false_if_on,HDIM128)
export FLASH_ATTENTION_DISABLE_HDIM192 := $(call bool_false_if_on,HDIM192)
export FLASH_ATTENTION_DISABLE_HDIM256 := $(call bool_false_if_on,HDIM256)
export FLASH_ATTENTION_DISABLE_SM80 := $(call bool_false_if_on,SM8X)
export FLASH_ATTENTION_ENABLE_VCOLMAJOR := $(call bool_true_if_on,VCOLMAJOR)
export FLASH_ATTENTION_DISABLE_HDIMDIFF64 := $(call bool_false_if_on,HDIMDIFF64)
export FLASH_ATTENTION_DISABLE_HDIMDIFF192 := $(call bool_false_if_on,HDIMDIFF192)

.PHONY: install show_flags help

install: show_flags
	$(PYTHON) setup.py install

tt:
	PYTHONPATH=$PWD python test_flash_attn.py

fm:
	PYTHONPATH=${PWD} ncu --set full --import-source yes --nvtx --nvtx-include "flash_varlen_fwd_kernel/"  -f -o flash_bwd.%p  python test_flash_attn.py

bm:
	PYTHONPATH=${PWD} ncu --set full --import-source yes --nvtx --nvtx-include "flash_varlen_bwd_kernel/"  -f -o flash_bwd.%p  python test_flash_attn.py

show_flags:
	@echo "Build flags -> envï¼š"
	@echo " BACKWARD=$(BACKWARD) -> FLASH_ATTENTION_DISABLE_BACKWARD=$(FLASH_ATTENTION_DISABLE_BACKWARD)"
	@echo " SPLIT=$(SPLIT) -> FLASH_ATTENTION_DISABLE_SPLIT=$(FLASH_ATTENTION_DISABLE_SPLIT)"
	@echo " PAGEDKV=$(PAGEDKV) -> FLASH_ATTENTION_DISABLE_PAGEDKV=$(FLASH_ATTENTION_DISABLE_PAGEDKV)"
	@echo " APPENDKV=$(APPENDKV) -> FLASH_ATTENTION_DISABLE_APPENDKV=$(FLASH_ATTENTION_DISABLE_APPENDKV)"
	@echo " LOCAL=$(LOCAL) -> FLASH_ATTENTION_DISABLE_LOCAL=$(FLASH_ATTENTION_DISABLE_LOCAL)"
	@echo " SOFTCAP=$(SOFTCAP) -> FLASH_ATTENTION_DISABLE_SOFTCAP=$(FLASH_ATTENTION_DISABLE_SOFTCAP)"
	@echo " PACKGQA=$(PACKGQA) -> FLASH_ATTENTION_DISABLE_PACKGQA=$(FLASH_ATTENTION_DISABLE_PACKGQA)"
	@echo " FP16=$(FP16) -> FLASH_ATTENTION_DISABLE_FP16=$(FLASH_ATTENTION_DISABLE_FP16)"
	@echo " FP8=$(FP8) -> FLASH_ATTENTION_DISABLE_FP8=$(FLASH_ATTENTION_DISABLE_FP8)"
	@echo " VARLEN=$(VARLEN) -> FLASH_ATTENTION_DISABLE_VARLEN=$(FLASH_ATTENTION_DISABLE_VARLEN)"
	@echo " CLUSTER=$(CLUSTER) -> FLASH_ATTENTION_DISABLE_CLUSTER=$(FLASH_ATTENTION_DISABLE_CLUSTER)"
	@echo " HDIM64=$(HDIM64) -> FLASH_ATTENTION_DISABLE_HDIM64=$(FLASH_ATTENTION_DISABLE_HDIM64)"
	@echo " HDIM96=$(HDIM96) -> FLASH_ATTENTION_DISABLE_HDIM96=$(FLASH_ATTENTION_DISABLE_HDIM96)"
	@echo " HDIM128=$(HDIM128) -> FLASH_ATTENTION_DISABLE_HDIM128=$(FLASH_ATTENTION_DISABLE_HDIM128)"
	@echo " HDIM192=$(HDIM192) -> FLASH_ATTENTION_DISABLE_HDIM192=$(FLASH_ATTENTION_DISABLE_HDIM192)"
	@echo " HDIM256=$(HDIM256) -> FLASH_ATTENTION_DISABLE_HDIM256=$(FLASH_ATTENTION_DISABLE_HDIM256)"
	@echo " SM8X=$(SM8X) -> FLASH_ATTENTION_DISABLE_SM80=$(FLASH_ATTENTION_DISABLE_SM80)"
	@echo " VCOLMAJOR=$(VCOLMAJOR) -> FLASH_ATTENTION_ENABLE_VCOLMAJOR=$(FLASH_ATTENTION_ENABLE_VCOLMAJOR)"
	@echo " HDIMDIFF64=$(HDIMDIFF64) -> FLASH_ATTENTION_DISABLE_HDIMDIFF64=$(FLASH_ATTENTION_DISABLE_HDIMDIFF64)"
	@echo " HDIMDIFF192=$(HDIMDIFF192) -> FLASH_ATTENTION_DISABLE_HDIMDIFF192=$(FLASH_ATTENTION_DISABLE_HDIMDIFF192)"



